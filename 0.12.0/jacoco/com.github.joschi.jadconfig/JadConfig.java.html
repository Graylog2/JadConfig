<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JadConfig.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JadConfig</a> &gt; <a href="index.source.html" class="el_package">com.github.joschi.jadconfig</a> &gt; <span class="el_source">JadConfig.java</span></div><h1>JadConfig.java</h1><pre class="source lang-java linenums">package com.github.joschi.jadconfig;

import com.github.joschi.jadconfig.converters.NoConverter;
import com.github.joschi.jadconfig.converters.StringConverter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;

import static com.github.joschi.jadconfig.ReflectionUtils.getAllFields;
import static com.github.joschi.jadconfig.ReflectionUtils.getAllMethods;
import static com.github.joschi.jadconfig.ReflectionUtils.invokeMethodsWithAnnotation;

/**
 * The main class for JadConfig. It's responsible for parsing the configuration bean(s) that contain(s) the annotated
 * fields, use a {@link Repository} to read the raw configuration and assign the fields with the correct values.
 * &lt;p/&gt;
 * The configuration bean(s) you pass in the constructor are expected to have one or more {@link Parameter} annotations
 * on them.
 * &lt;p/&gt;
 * You can pass either a single configuration bean or an array of objects. In the case of an array JadConfig will
 * collect the {@link Parameter} annotations from all the objects passed in.
 *
 * @author jschalanda
 */
public class JadConfig {
<span class="fc" id="L37">    private static final Logger LOG = LoggerFactory.getLogger(JadConfig.class);</span>
<span class="fc" id="L38">    private final LinkedList&lt;ConverterFactory&gt; converterFactories = new LinkedList&lt;ConverterFactory&gt;();</span>
    private List&lt;Object&gt; configurationBeans;
    private List&lt;Repository&gt; repositories;

    /**
     * Creates a new (empty) instance of JadConfig.
     * &lt;p/&gt;
     * Configuration beans will have to be added with {@link #addConfigurationBean(Object)} and a {@link Repository}
     * will have to be set with {@link #setRepository(Repository)} or {@link #setRepositories(Collection)}.
     *
     * @see #addConfigurationBean(Object)
     * @see #setRepository(Repository)
     * @see #setRepositories(Collection)
     */
    public JadConfig() {
<span class="fc" id="L53">        this(Collections.&lt;Repository&gt;emptyList());</span>
<span class="fc" id="L54">    }</span>

    /**
     * Creates a new instance of JadConfig backed by the provided {@link Repository} and filling the provided
     * {@literal configurationBeans}.
     *
     * @param repository         A {@link Repository} for interfacing with the configuration data
     * @param configurationBeans One or more objects annotated with JadConfig annotations
     */
    public JadConfig(Repository repository, Object... configurationBeans) {
<span class="fc" id="L64">        this(Collections.singletonList(repository), configurationBeans);</span>
<span class="fc" id="L65">    }</span>

    /**
     * Creates a new instance of JadConfig backed by the provided {@link Repository}s and filling the provided
     * {@literal configurationBeans}.
     *
     * @param repositories       A collection of {@link Repository}s for interfacing with the configuration data
     * @param configurationBeans One or more objects annotated with JadConfig annotations
     */
<span class="fc" id="L74">    public JadConfig(Collection&lt;Repository&gt; repositories, Object... configurationBeans) {</span>
<span class="fc" id="L75">        this.configurationBeans = new ArrayList&lt;Object&gt;(Arrays.asList(configurationBeans));</span>
<span class="fc" id="L76">        this.repositories = new ArrayList&lt;Repository&gt;(repositories);</span>

<span class="fc" id="L78">        converterFactories.add(new DefaultConverterFactory());</span>
<span class="fc" id="L79">    }</span>


    /**
     * Processes the configuration provided by the configured {@link Repository} and filling the provided configuration
     * beans.
     *
     * @throws RepositoryException If an error occurred while reading from the configured {@link Repository}
     * @throws ValidationException If any parameter couldn't be successfully validated
     */
    public void process() throws RepositoryException, ValidationException {

<span class="fc bfc" id="L91" title="All 2 branches covered.">        for (Repository repository : repositories) {</span>
<span class="fc" id="L92">            LOG.debug(&quot;Opening repository {}&quot;, repository);</span>
<span class="fc" id="L93">            repository.open();</span>
<span class="fc" id="L94">        }</span>

<span class="fc bfc" id="L96" title="All 2 branches covered.">        for (Object configurationBean : configurationBeans) {</span>
<span class="fc" id="L97">            LOG.debug(&quot;Processing configuration bean {}&quot;, configurationBean);</span>

<span class="fc" id="L99">            processClassFields(configurationBean, getAllFields(configurationBean.getClass()));</span>
<span class="fc" id="L100">            invokeValidatorMethods(configurationBean, getAllMethods(configurationBean.getClass()));</span>
<span class="fc" id="L101">        }</span>
<span class="fc" id="L102">    }</span>


    private void processClassFields(Object configurationBean, Field[] fields) throws ValidationException {
<span class="fc bfc" id="L106" title="All 2 branches covered.">        for (Field field : fields) {</span>
<span class="fc" id="L107">            Parameter parameter = field.getAnnotation(Parameter.class);</span>

<span class="fc bfc" id="L109" title="All 2 branches covered.">            if (parameter != null) {</span>
<span class="fc" id="L110">                LOG.debug(&quot;Processing field {}&quot;, parameter);</span>

<span class="fc" id="L112">                Object fieldValue = getFieldValue(field, configurationBean);</span>

<span class="fc" id="L114">                String parameterName = parameter.value();</span>
<span class="fc" id="L115">                String parameterValue = null;</span>

<span class="fc bfc" id="L117" title="All 2 branches covered.">                for (Repository repository : repositories) {</span>
<span class="fc" id="L118">                    LOG.debug(&quot;Looking up parameter {} in repository {}&quot;, parameterName, repository);</span>
<span class="fc" id="L119">                    parameterValue = repository.read(parameterName);</span>

<span class="fc bfc" id="L121" title="All 2 branches covered.">                    if (null != parameterValue) {</span>
<span class="fc" id="L122">                        break;</span>
                    }
<span class="fc" id="L124">                }</span>

<span class="fc bfc" id="L126" title="All 6 branches covered.">                if (parameterValue == null &amp;&amp; fieldValue == null &amp;&amp; parameter.required()) {</span>
<span class="fc" id="L127">                    throw new ParameterException(&quot;Required parameter \&quot;&quot; + parameterName + &quot;\&quot; not found.&quot;);</span>
                }

<span class="fc bfc" id="L130" title="All 2 branches covered.">                if (parameterValue != null) {</span>

<span class="fc bfc" id="L132" title="All 2 branches covered.">                    if (parameter.trim()) {</span>
<span class="fc" id="L133">                        LOG.debug(&quot;Trimmed parameter value {}&quot;, parameterName);</span>
<span class="fc" id="L134">                        parameterValue = Strings.trim(parameterValue);</span>
                    }

<span class="fc" id="L137">                    LOG.debug(&quot;Converting parameter value {}&quot;, parameterName);</span>
                    try {
<span class="fc" id="L139">                        fieldValue = convertStringValue(field.getType(), parameter.converter(), parameterValue);</span>
<span class="fc" id="L140">                    } catch (ParameterException e) {</span>
<span class="fc" id="L141">                        throw new ParameterException(&quot;Couldn't convert value for parameter \&quot;&quot; + parameterName + &quot;\&quot;&quot;, e);</span>
<span class="fc" id="L142">                    }</span>

<span class="fc" id="L144">                    LOG.debug(&quot;Validating parameter {}&quot;, parameterName);</span>
<span class="fc" id="L145">                    final List&lt;Class&lt;? extends Validator&lt;?&gt;&gt;&gt; validators =</span>
<span class="fc" id="L146">                            new ArrayList&lt;&gt;(Collections.&lt;Class&lt;? extends Validator&lt;?&gt;&gt;&gt;singleton(parameter.validator()));</span>
<span class="fc" id="L147">                    validators.addAll(Arrays.asList(parameter.validators()));</span>
<span class="fc" id="L148">                    validateParameter(validators, parameterName, fieldValue);</span>
                }

<span class="fc" id="L151">                LOG.debug(&quot;Setting parameter {} to {}&quot;, parameterName, parameterValue);</span>

                try {
<span class="fc" id="L154">                    field.set(configurationBean, fieldValue);</span>
<span class="fc" id="L155">                } catch (Exception e) {</span>
<span class="fc" id="L156">                    throw new ParameterException(&quot;Couldn't set field &quot; + field.getName(), e);</span>
<span class="fc" id="L157">                }</span>
            }
        }
<span class="fc" id="L160">    }</span>

    private Object convertStringValue(Class&lt;?&gt; fieldType, Class&lt;? extends Converter&lt;?&gt;&gt; converterClass, String stringValue) {
<span class="fc" id="L163">        final Converter converter = getConverter(fieldType, converterClass);</span>

<span class="fc" id="L165">        LOG.debug(&quot;Loaded converter class for type {}: {}&quot;, fieldType, converter);</span>

<span class="fc" id="L167">        return converter.convertFrom(stringValue);</span>
    }

    private Object getFieldValue(Field field, Object bean) {
        try {
<span class="fc" id="L172">            return ReflectionUtils.getFieldValue(bean, field);</span>
<span class="nc" id="L173">        } catch (IllegalAccessException e) {</span>
<span class="nc" id="L174">            throw new ParameterException(&quot;Couldn't obtain value of field &quot; + field.getName(), e);</span>
        }
    }

    private Converter getConverter(Class&lt;?&gt; fieldType, Class&lt;? extends Converter&lt;?&gt;&gt; converterClass) {

<span class="fc" id="L180">        LOG.debug(&quot;Trying to find converter class {} for type {}&quot;, converterClass, fieldType);</span>

<span class="fc" id="L182">        Class&lt;? extends Converter&lt;?&gt;&gt; clazz = converterClass;</span>

<span class="pc bpc" id="L184" title="1 of 4 branches missed.">        if (clazz == null || clazz == NoConverter.class) {</span>
<span class="fc" id="L185">            clazz = findConverter(fieldType);</span>
        }

        // Fallback to StringConverter
<span class="fc bfc" id="L189" title="All 2 branches covered.">        if (clazz == null) {</span>
<span class="fc" id="L190">            clazz = StringConverter.class;</span>

<span class="fc" id="L192">            LOG.debug(&quot;Using fallback converter: {}&quot;, clazz);</span>
        }

        try {
<span class="fc" id="L196">            return clazz.newInstance();</span>
<span class="nc" id="L197">        } catch (Exception e) {</span>
<span class="nc" id="L198">            throw new ParameterException(&quot;Couldn't initialize converter class &quot; + clazz.getCanonicalName(), e);</span>
        }
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    private void validateParameter(Collection&lt;Class&lt;? extends Validator&lt;?&gt;&gt;&gt; validatorClasses,
                                   String name, Object value) throws ValidationException {
<span class="fc" id="L205">        LOG.debug(&quot;Validating parameter {} with value {}&quot;, name, value);</span>

<span class="fc bfc" id="L207" title="All 2 branches covered.">        for(Class&lt;? extends Validator&lt;?&gt;&gt; validatorClass : validatorClasses) {</span>
            Validator validator;
            try {
<span class="fc" id="L210">                validator = validatorClass.newInstance();</span>
<span class="nc" id="L211">            } catch (Exception e) {</span>
<span class="nc" id="L212">                throw new ParameterException(&quot;Couldn't initialize validator &quot; + validatorClass.getCanonicalName(), e);</span>
<span class="fc" id="L213">            }</span>

<span class="fc" id="L215">            validator.validate(name, value);</span>
<span class="fc" id="L216">        }</span>
<span class="fc" id="L217">    }</span>

    private void invokeValidatorMethods(Object configurationBean, Method[] methods) throws ValidationException {
        try {
<span class="fc" id="L221">            invokeMethodsWithAnnotation(configurationBean, ValidatorMethod.class, methods);</span>
<span class="fc" id="L222">        } catch (InvocationTargetException e) {</span>
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">            if (e.getTargetException() instanceof ValidationException) {</span>
<span class="fc" id="L224">                throw (ValidationException)e.getTargetException();</span>
            }

<span class="nc" id="L227">            throw new ValidationException(&quot;Couldn't run validator method&quot;, e);</span>
<span class="nc" id="L228">        } catch (Exception e) {</span>
<span class="nc" id="L229">            throw new ValidationException(&quot;Couldn't run validator method&quot;, e);</span>
<span class="fc" id="L230">        }</span>
<span class="fc" id="L231">    }</span>

    private &lt;T&gt; Class&lt;? extends Converter&lt;T&gt;&gt; findConverter(Class&lt;T&gt; clazz) {
<span class="fc bfc" id="L234" title="All 2 branches covered.">        for (ConverterFactory factory : converterFactories) {</span>
<span class="fc" id="L235">            Class&lt;? extends Converter&lt;T&gt;&gt; result = factory.getConverter(clazz);</span>

<span class="fc bfc" id="L237" title="All 2 branches covered.">            if (result != null) {</span>
<span class="fc" id="L238">                return result;</span>
            }
<span class="fc" id="L240">        }</span>

<span class="fc" id="L242">        return null;</span>
    }

    /**
     * Adds a {@link ConverterFactory} for processing additional types
     *
     * @param converterFactory The {@link ConverterFactory} to be added
     * @return the JadConfig instance
     */
    public JadConfig addConverterFactory(ConverterFactory converterFactory) {
<span class="fc" id="L252">        converterFactories.addFirst(converterFactory);</span>

<span class="fc" id="L254">        LOG.info(&quot;Added converter factory {}&quot;, converterFactory);</span>
<span class="fc" id="L255">        return this;</span>
    }

    /**
     * Adds a configuration bean annotated with JadConfig annotations.
     *
     * @param configurationBean An object annotated with JadConfig annotations
     * @return the JadConfig instance
     */
    public JadConfig addConfigurationBean(Object configurationBean) {
<span class="fc" id="L265">        configurationBeans.add(configurationBean);</span>

<span class="fc" id="L267">        LOG.info(&quot;Added configuration bean {}&quot;, configurationBean);</span>
<span class="fc" id="L268">        return this;</span>
    }

    /**
     * Dumps all configuration parameters as a {@link java.util.Map} of {@link String}.
     * &lt;p&gt;
     * If being called before {@link #process()} it will return the default values of the configuration beans.
     * &lt;/p&gt;
     *
     * @return All configuration parameters as {@link String}
     */
    public Map&lt;String, String&gt; dump() {
<span class="fc" id="L280">        final Map&lt;String, String&gt; configurationDump = new HashMap&lt;String, String&gt;();</span>

<span class="fc bfc" id="L282" title="All 2 branches covered.">        for (Object configurationBean : configurationBeans) {</span>
<span class="fc bfc" id="L283" title="All 2 branches covered.">            for (Field field : getAllFields(configurationBean.getClass())) {</span>
<span class="fc" id="L284">                final Parameter parameter = field.getAnnotation(Parameter.class);</span>

<span class="fc bfc" id="L286" title="All 2 branches covered.">                if (parameter != null) {</span>
<span class="fc" id="L287">                    final Object fieldValue = getFieldValue(field, configurationBean);</span>
<span class="fc" id="L288">                    configurationDump.put(parameter.value(), convertFieldValue(field.getType(), parameter.converter(), fieldValue));</span>
                }
            }
<span class="fc" id="L291">        }</span>

<span class="fc" id="L293">        return configurationDump;</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    private String convertFieldValue(Class&lt;?&gt; fieldType, Class&lt;? extends Converter&lt;?&gt;&gt; converterClass, Object fieldValue) {
<span class="pc bpc" id="L298" title="1 of 2 branches missed.">        if (null != fieldValue) {</span>
<span class="fc" id="L299">            final Converter converter = getConverter(fieldType, converterClass);</span>

<span class="fc" id="L301">            LOG.debug(&quot;Converting {} to type {} using converter {}&quot;, fieldValue, fieldType, converter);</span>
<span class="fc" id="L302">            return converter.convertTo(fieldValue);</span>
        } else {
<span class="nc" id="L304">            return &quot;null&quot;;</span>
        }
    }

    /**
     * Set the {@link Repository} to load configuration data from.
     *
     * @param repository A {@link Repository} instance
     * @return the JadConfig instance
     */
    public JadConfig setRepository(final Repository repository) {
<span class="pc bpc" id="L315" title="1 of 2 branches missed.">        if(repository == null) {</span>
<span class="fc" id="L316">            throw new IllegalArgumentException(&quot;The repository must not be null.&quot;);</span>
        }

<span class="nc" id="L319">        this.repositories = Collections.singletonList(repository);</span>
<span class="nc" id="L320">        return this;</span>
    }

    /**
     * Set the (sorted) list of {@link Repository}s to load configuration data from.
     *
     * @param repositories A collection of {@link Repository} instances
     * @return the JadConfig instance
     */
    public JadConfig setRepositories(final Collection&lt;Repository&gt; repositories) {
<span class="pc bpc" id="L330" title="1 of 4 branches missed.">        if(repositories == null || repositories.isEmpty()) {</span>
<span class="fc" id="L331">            throw new IllegalArgumentException(&quot;At least 1 repository is required.&quot;);</span>
        }
<span class="nc" id="L333">        this.repositories = new ArrayList&lt;Repository&gt;(repositories);</span>
<span class="nc" id="L334">        return this;</span>
    }

    /**
     * Set the (sorted) list of {@link Repository}s to load configuration data from.
     *
     * @param repositories A collection of {@link Repository} instances
     * @return the JadConfig instance
     */
    public JadConfig setRepositories(Repository... repositories) {
<span class="pc bpc" id="L344" title="1 of 4 branches missed.">        if(repositories == null || repositories.length &lt; 1) {</span>
<span class="fc" id="L345">            throw new IllegalArgumentException(&quot;At least 1 repository is required.&quot;);</span>
        }

<span class="nc" id="L348">        this.repositories = new ArrayList&lt;Repository&gt;(Arrays.asList(repositories));</span>
<span class="nc" id="L349">        return this;</span>
    }

    /**
     * Get an unmodifiable list of registered converter factories.
     *
     * @return the list of registered converter factories
     */
    public List&lt;ConverterFactory&gt; getConverterFactories() {
<span class="fc" id="L358">        return Collections.unmodifiableList(converterFactories);</span>
    }

    /**
     * Get an unmodifiable list of registered configuration beans.
     *
     * @return the list of registered configuration beans
     */
    public List&lt;Object&gt; getConfigurationBeans() {
<span class="fc" id="L367">        return Collections.unmodifiableList(configurationBeans);</span>
    }

    /**
     * Get an unmodifiable list of registered repositories.
     *
     * @return the list of registered repositories
     */
    public List&lt;Repository&gt; getRepositories() {
<span class="fc" id="L376">        return Collections.unmodifiableList(repositories);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>